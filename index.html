<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR Audio Experience</title>

    <script src="https://aframe.io/releases/1.7.0/aframe.min.js?v=12"></script>

    <style>
      /* Full-screen START overlay */
      #startOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999999;
      }

      #startButton {
        padding: 20px 40px;
        font-size: 2rem;
        background: white;
        color: black;
        border-radius: 12px;
        border: none;
      }
    </style>

    <!-- PROXIMITY TRIGGER LOGIC -->
    <script>
      AFRAME.registerComponent("proximity-trigger", {
        schema: {
          sound: {type:"selector"},
          nextsound: {type:"selector"},
          distance: {default:1.5},
          asphere: {type:"selector"},
          bsphere: {type:"selector"},
          ambient: {type:"selector"}
        },

        init: function () {
          this.primaryPlayed = false;
          this.secondaryPlayed = false;
          this.insideZone = false;

          // Hide B sphere initially
          if (this.data.bsphere) {
            this.data.bsphere.setAttribute("visible", "false");
          }

          const self = this;
          const A = this.data.sound?.components.sound;
          const B = this.data.nextsound?.components.sound;

          // A ends â†’ hide A sphere â†’ show B sphere â†’ play B
          if (A) {
            this.data.sound.addEventListener("sound-ended", () => {
              if (self.data.asphere) self.data.asphere.setAttribute("visible","false");

              if (self.data.bsphere) self.data.bsphere.setAttribute("visible","true");

              if (!self.secondaryPlayed && B) {
                B.playSound();
                self.secondaryPlayed = true;
              }
            });
          }

          // B ends â†’ hide B sphere
          if (B) {
            this.data.nextsound.addEventListener("sound-ended", () => {
              if (self.data.bsphere) self.data.bsphere.setAttribute("visible","false");
            });
          }
        },

        tick: function () {
          const cam = this.el.sceneEl.camera.el.object3D.position;
          const pos = this.el.object3D.position;
          const dist = cam.distanceTo(pos);
          const ambient = this.data.ambient?.components.sound;

          const inside = dist < this.data.distance;

          // ENTER
          if (inside && !this.insideZone) {
            this.insideZone = true;

            if (ambient) ambient.pauseSound();

            // play A once
            if (!this.primaryPlayed && this.data.sound) {
              const A = this.data.sound.components.sound;
              if (!A.isPlaying) A.playSound();
              this.primaryPlayed = true;
            }
          }

          // EXIT
          if (!inside && this.insideZone) {
            this.insideZone = false;

            if (this.data.sound?.components.sound) {
              this.data.sound.components.sound.stopSound();
            }
            if (this.data.nextsound?.components.sound) {
              this.data.nextsound.components.sound.stopSound();
            }

            if (ambient) ambient.playSound();
          }
        }
      });
    </script>

  </head>

  <body>

    <!-- START SCREEN -->
    <div id="startOverlay">
      <button id="startButton">START</button>
    </div>

    <a-scene
      renderer="colorManagement: true;"
      vr-mode-ui="enabled: false"
      ar-mode-ui="enabled: false">

      <a-entity id="camera" camera look-controls></a-entity>

      <!-- INTRO AUDIO -->
      <a-entity id="intro"
        sound="src: url(assets/audio/audio_Intro.wav?v=12); autoplay: false; loop: false; volume: 1.0; positional: false;">
      </a-entity>

      <!-- AMBIENCE AUDIO (starts silent) -->
      <a-entity id="ambient"
        sound="src: url(assets/audio/audio_Ambience.wav?v=12); autoplay: false; loop: true; volume: 0.0; positional: false;">
      </a-entity>

      <!-- === CORNER 1 === -->
      <a-sphere id="a1" color="#FFD400" radius="0.15" position="1 1 -1"></a-sphere>
      <a-sphere id="b1" color="#00FFFF" radius="0.15" position="1 1 -2.5"></a-sphere>

      <a-entity id="corner1" position="1 1 -1"
        proximity-trigger="sound:#s1; nextsound:#s1b; distance:1.5;
                           asphere:#a1; bsphere:#b1; ambient:#ambient"></a-entity>

      <a-entity id="s1"  sound="src: url(assets/audio/audio_1.wav?v=12); positional: true;"></a-entity>
      <a-entity id="s1b" sound="src: url(assets/audio/audio_1b.wav?v=12); positional: true;"></a-entity>

      <!-- === CORNER 2 === -->
      <a-sphere id="a2" color="#FFD400" radius="0.15" position="-1 1 -1"></a-sphere>
      <a-sphere id="b2" color="#00FFFF" radius="0.15" position="-1 1 -2.5"></a-sphere>

      <a-entity id="corner2" position="-1 1 -1"
        proximity-trigger="sound:#s2; nextsound:#s2b; distance:1.5;
                           asphere:#a2; bsphere:#b2; ambient:#ambient"></a-entity>

      <a-entity id="s2"  sound="src: url(assets/audio/audio_2.wav?v=12); positional: true;"></a-entity>
      <a-entity id="s2b" sound="src: url(assets/audio/audio_2b.wav?v=12); positional: true;"></a-entity>

      <!-- === CORNER 3 === -->
      <a-sphere id="a3" color="#FFD400" radius="0.15" position="1 1 1"></a-sphere>
      <a-sphere id="b3" color="#00FFFF" radius="0.15" position="1 1 2.5"></a-sphere>

      <a-entity id="corner3" position="1 1 1"
        proximity-trigger="sound:#s3; nextsound:#s3b; distance:1.5;
                           asphere:#a3; bsphere:#b3; ambient:#ambient"></a-entity>

      <a-entity id="s3"  sound="src: url(assets/audio/audio_3.wav?v=12); positional: true;"></a-entity>
      <a-entity id="s3b" sound="src: url(assets/audio/audio_3b.wav?v=12); positional: true;"></a-entity>

      <!-- === CORNER 4 === -->
      <a-sphere id="a4" color="#FFD400" radius="0.15" position="-1 1 1"></a-sphere>
      <a-sphere id="b4" color="#00FFFF" radius="0.15" position="-1 1 2.5"></a-sphere>

      <a-entity id="corner4" position="-1 1 1"
        proximity-trigger="sound:#s4; nextsound:#s4b; distance:1.5;
                           asphere:#a4; bsphere:#b4; ambient:#ambient"></a-entity>

      <a-entity id="s4"  sound="src: url(assets/audio/audio_4.wav?v=12); positional: true;"></a-entity>
      <a-entity id="s4b" sound="src: url(assets/audio/audio_4b.wav?v=12); positional: true;"></a-entity>

    </a-scene>

    <!-- CROSSFADE + PLATFORM LOGIC -->
    <script>
      // Detect iPhone/iPad
      function isIOS() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      // Crossfade intro â†’ ambience
      function crossfade(intro, amb, fadeTime = 2000) {
        let start = null;
        function step(ts) {
          if (!start) start = ts;
          let p = (ts - start) / fadeTime;
          if (p > 1) p = 1;

          intro.components.sound.setVolume(1 - p);
          amb.components.sound.setVolume(p);

          if (p < 1) requestAnimationFrame(step);
          else intro.components.sound.stopSound();
        }
        requestAnimationFrame(step);
      }

      // START BUTTON HANDLER
      document.querySelector("#startButton").addEventListener("click", async () => {
        const overlay = document.querySelector("#startOverlay");
        const intro = document.querySelector("#intro");
        const amb = document.querySelector("#ambient");
        const scene = document.querySelector("a-scene");

        // iPhone â†’ Audio-only mode
        if (isIOS()) {
          console.log("ðŸŽ iPhone detected â†’ Audio-Only Mode");

          intro.components.sound.playSound();
          intro.addEventListener("sound-ended", () => {
            amb.components.sound.playSound();
            crossfade(intro, amb, 2000);
          });

          overlay.style.display = "none";
          return;
        }

        // Android â†’ AR debug mode
        console.log("ðŸ¤– Android detected â†’ AR Debug Mode");

        intro.components.sound.playSound();
        intro.addEventListener("sound-ended", () => {
          amb.components.sound.playSound();
          crossfade(intro, amb, 2000);
        });

        overlay.style.display = "none";

        try {
          await scene.enterAR();
        } catch (e) {
          console.warn("AR not available:", e);
        }
      });
    </script>

  </body>
</html>
